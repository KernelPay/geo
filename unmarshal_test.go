package geo

import (
	"encoding/hex"
	"reflect"
	"testing"
)

var unmarshalTestCases = []struct {
	t         geom
	geo       geom
	marshaled string
}{
	{&Point{}, &Point{1, 2}, "0101000000000000000000F03F0000000000000040"},
	{&PointS{}, &PointS{Point{1, 2}, 1234}, "0101000020D2040000000000000000F03F0000000000000040"},
	{&Point{}, &Point{1, 2}, "0101000020D2040000000000000000F03F0000000000000040"},
	{&PointZ{}, &PointZ{1, 2, 3}, "0101000080000000000000F03F00000000000000400000000000000840"},
	{&Point{}, &Point{1, 2}, "0101000080000000000000F03F00000000000000400000000000000840"},
	{&PointM{}, &PointM{1, 2, 3}, "0101000040000000000000F03F00000000000000400000000000000840"},
	{&PointZM{}, &PointZM{1, 2, 3, 4}, "01010000C0000000000000F03F000000000000004000000000000008400000000000001040"},

	// Test upcast Point
	{&Point{}, &Point{1, 2}, "0101000000000000000000F03F0000000000000040"},
	{&PointS{}, &PointS{Point{1, 2}, 0}, "0101000000000000000000F03F0000000000000040"},
	{&PointZ{}, &PointZ{1, 2, 0}, "0101000000000000000000F03F0000000000000040"},
	{&PointZS{}, &PointZS{PointZ{1, 2, 0}, 0}, "0101000000000000000000F03F0000000000000040"},
	{&PointM{}, &PointM{1, 2, 0}, "0101000000000000000000F03F0000000000000040"},
	{&PointMS{}, &PointMS{PointM{1, 2, 0}, 0}, "0101000000000000000000F03F0000000000000040"},
	{&PointZM{}, &PointZM{1, 2, 0, 0}, "0101000000000000000000F03F0000000000000040"},
	{&PointZMS{}, &PointZMS{PointZM{1, 2, 0, 0}, 0}, "0101000000000000000000F03F0000000000000040"},

	// Test downcast PointZMS
	{&Point{}, &Point{1, 2}, "01010000E0D2040000000000000000F03F000000000000004000000000000008400000000000001040"},
	{&PointS{}, &PointS{Point{1, 2}, 1234}, "01010000E0D2040000000000000000F03F000000000000004000000000000008400000000000001040"},
	{&PointZ{}, &PointZ{1, 2, 3}, "01010000E0D2040000000000000000F03F000000000000004000000000000008400000000000001040"},
	{&PointZS{}, &PointZS{PointZ{1, 2, 3}, 1234}, "01010000E0D2040000000000000000F03F000000000000004000000000000008400000000000001040"},
	{&PointM{}, &PointM{1, 2, 4}, "01010000E0D2040000000000000000F03F000000000000004000000000000008400000000000001040"},
	{&PointMS{}, &PointMS{PointM{1, 2, 4}, 1234}, "01010000E0D2040000000000000000F03F000000000000004000000000000008400000000000001040"},
	{&PointZM{}, &PointZM{1, 2, 3, 4}, "01010000E0D2040000000000000000F03F000000000000004000000000000008400000000000001040"},
	{&PointZMS{}, &PointZMS{PointZM{1, 2, 3, 4}, 1234}, "01010000E0D2040000000000000000F03F000000000000004000000000000008400000000000001040"},

	// Upcast +M, Downcast -Z
	{&PointM{}, &PointM{1, 2, 0}, "0101000080000000000000F03F00000000000000400000000000000840"},

	// Test LineString
	{&LineString{}, &LineString{Point{1, 2}, Point{3, 4}}, "010200000002000000000000000000F03F000000000000004000000000000008400000000000001040"},
	{&LineStringZ{}, &LineStringZ{PointZ{1, 2, 3}, PointZ{4, 5, 6}}, "010200008002000000000000000000F03F00000000000000400000000000000840000000000000104000000000000014400000000000001840"},
	{&LineStringM{}, &LineStringM{PointM{1, 2, 3}, PointM{4, 5, 6}}, "010200004002000000000000000000F03F00000000000000400000000000000840000000000000104000000000000014400000000000001840"},
	{&LineStringZM{}, &LineStringZM{PointZM{1, 2, 3, 4}, PointZM{5, 6, 7, 8}}, "01020000C002000000000000000000F03F000000000000004000000000000008400000000000001040000000000000144000000000000018400000000000001C400000000000002040"},
	// Downcast
	{&LineString{}, &LineString{Point{1, 2}, Point{5, 6}}, "01020000C002000000000000000000F03F000000000000004000000000000008400000000000001040000000000000144000000000000018400000000000001C400000000000002040"},
	// Upcast +S
	{&LineStringZMS{}, &LineStringZMS{LineStringZM{PointZM{1, 2, 3, 4}, PointZM{5, 6, 7, 8}}, 0}, "01020000C002000000000000000000F03F000000000000004000000000000008400000000000001040000000000000144000000000000018400000000000001C400000000000002040"},

	{
		&Polygon{},
		&Polygon{
			Coordinates: LineString{Point{1, 2}, Point{3, 4}, Point{5, 6}, Point{1, 2}},
			Holes:       []LineString{},
		},
		"01030000000100000004000000000000000000F03F00000000000000400000000000000840000000000000104000000000000014400000000000001840000000000000F03F0000000000000040",
	},

	{
		&Polygon{},
		&Polygon{
			Coordinates: LineString{Point{1, 2}, Point{3, 4}, Point{5, 6}, Point{1, 2}},
			Holes: []LineString{
				LineString{Point{9, 8}, Point{7, 6}, Point{5, 4}, Point{9, 8}},
				LineString{Point{6, 5}, Point{4, 3}, Point{2, 1}, Point{6, 5}},
			},
		},
		"01030000000300000004000000000000000000F03F00000000000000400000000000000840000000000000104000000000000014400000000000001840000000000000F03F000000000000004004000000000000000000224000000000000020400000000000001C40000000000000184000000000000014400000000000001040000000000000224000000000000020400400000000000000000018400000000000001440000000000000104000000000000008400000000000000040000000000000F03F00000000000018400000000000001440",
	},

	{
		&PolygonS{},
		&PolygonS{Polygon{
			Coordinates: LineString{Point{1, 2}, Point{3, 4}, Point{5, 6}, Point{1, 2}},
			Holes: []LineString{
				LineString{Point{9, 8}, Point{7, 6}, Point{5, 4}, Point{9, 8}},
				LineString{Point{6, 5}, Point{4, 3}, Point{2, 1}, Point{6, 5}},
			},
		}, 1234},
		"0103000020D20400000300000004000000000000000000F03F00000000000000400000000000000840000000000000104000000000000014400000000000001840000000000000F03F000000000000004004000000000000000000224000000000000020400000000000001C40000000000000184000000000000014400000000000001040000000000000224000000000000020400400000000000000000018400000000000001440000000000000104000000000000008400000000000000040000000000000F03F00000000000018400000000000001440",
	},

	{
		&Polygon{},
		&Polygon{
			Coordinates: LineString{Point{1, 2}, Point{3, 4}, Point{5, 6}, Point{1, 2}},
			Holes: []LineString{
				LineString{Point{9, 8}, Point{7, 6}, Point{5, 4}, Point{9, 8}},
				LineString{Point{6, 5}, Point{4, 3}, Point{2, 1}, Point{6, 5}},
			},
		},
		"0103000020D20400000300000004000000000000000000F03F00000000000000400000000000000840000000000000104000000000000014400000000000001840000000000000F03F000000000000004004000000000000000000224000000000000020400000000000001C40000000000000184000000000000014400000000000001040000000000000224000000000000020400400000000000000000018400000000000001440000000000000104000000000000008400000000000000040000000000000F03F00000000000018400000000000001440",
	},

	{&MultiPoint{}, &MultiPoint{Point{1, 2}, Point{3, 4}}, "0104000000020000000101000000000000000000F03F0000000000000040010100000000000000000008400000000000001040"},
	{&MultiPointS{}, &MultiPointS{MultiPoint{Point{1, 2}, Point{3, 4}}, 1234}, "0104000020D2040000020000000101000000000000000000F03F0000000000000040010100000000000000000008400000000000001040"},
	{&MultiPoint{}, &MultiPoint{Point{1, 2}, Point{3, 4}}, "0104000020D2040000020000000101000000000000000000F03F0000000000000040010100000000000000000008400000000000001040"},
	{&MultiPointS{}, &MultiPointS{MultiPoint{Point{1, 2}, Point{3, 4}}, 0}, "0104000000020000000101000000000000000000F03F0000000000000040010100000000000000000008400000000000001040"},
	{&MultiPointZ{}, &MultiPointZ{PointZ{1, 2, 3}, PointZ{4, 5, 6}}, "0104000080020000000101000080000000000000F03F000000000000004000000000000008400101000080000000000000104000000000000014400000000000001840"},
	{&MultiPointM{}, &MultiPointM{PointM{1, 2, 3}, PointM{4, 5, 6}}, "0104000040020000000101000040000000000000F03F000000000000004000000000000008400101000040000000000000104000000000000014400000000000001840"},
	{&MultiPointZM{}, &MultiPointZM{PointZM{1, 2, 3, 4}, PointZM{5, 6, 7, 8}}, "01040000C00200000001010000C0000000000000F03F00000000000000400000000000000840000000000000104001010000C0000000000000144000000000000018400000000000001C400000000000002040"},
	{&MultiPoint{}, &MultiPoint{Point{1, 2}, Point{5, 6}}, "01040000C00200000001010000C0000000000000F03F00000000000000400000000000000840000000000000104001010000C0000000000000144000000000000018400000000000001C400000000000002040"},
	{&MultiPointS{}, &MultiPointS{MultiPoint{Point{1, 2}, Point{5, 6}}, 0}, "01040000C00200000001010000C0000000000000F03F00000000000000400000000000000840000000000000104001010000C0000000000000144000000000000018400000000000001C400000000000002040"},

	{&MultiLineString{}, &MultiLineString{LineString{Point{1, 2}, Point{3, 4}}, LineString{Point{5, 6}, Point{7, 8}}}, "010500000002000000010200000002000000000000000000F03F000000000000004000000000000008400000000000001040010200000002000000000000000000144000000000000018400000000000001C400000000000002040"},

	{
		&MultiPolygon{},
		&MultiPolygon{
			Polygon{
				Coordinates: LineString{Point{1, 2}, Point{3, 4}, Point{5, 6}, Point{1, 2}},
				Holes:       []LineString{},
			},
			Polygon{
				Coordinates: LineString{Point{9, 8}, Point{7, 6}, Point{5, 4}, Point{9, 8}},
				Holes:       []LineString{},
			},
		},
		"01060000000200000001030000000100000004000000000000000000F03F00000000000000400000000000000840000000000000104000000000000014400000000000001840000000000000F03F000000000000004001030000000100000004000000000000000000224000000000000020400000000000001C4000000000000018400000000000001440000000000000104000000000000022400000000000002040",
	},
	{
		// Multipolygon with empty polygons
		&MultiPolygon{},
		&MultiPolygon{
			Polygon{Coordinates: nil, Holes: nil},
			Polygon{Coordinates: nil, Holes: nil},
			Polygon{Coordinates: nil, Holes: nil},
			Polygon{Coordinates: nil, Holes: nil},
		},
		"0106000020E610000004000000010300000000000000010300000000000000010300000000000000010300000000000000",
	},
}

func TestUnmarshal(t *testing.T) {
	for i, c := range unmarshalTestCases {
		data, err := hex.DecodeString(c.marshaled)
		if err != nil {
			t.Fatalf("Error decoding hex in case #%d: %v", i, err)
		}

		actual := c.t
		err = Unmarshal(data, actual)
		if err != nil {
			t.Errorf("case #%d error: %v", i, err)
		}

		expected := c.geo
		if !reflect.DeepEqual(actual, expected) {
			t.Errorf("case #%d mismatch: Actual %v, expected %v", i, actual, expected)
		}
	}
}
